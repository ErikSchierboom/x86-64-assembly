#!/bin/bash

set -e

run_tests() {
    local exercise="$(basename $1)"
    local file="${exercise//-/_}"
    local implementation_file="${2}"

    cd "$1"

    sed -i.bak 's#TEST_IGNORE();#// &#' "${file}"_test.c
    mv .meta/"${implementation_file}".asm "${file}".asm

    make clean
    make

    cd ..
}

main() {
    cd "$(dirname "$0")"/..

    rm -rf build
    cp -r exercises build

    cd build

    for exercise_dir in concept/*; do
        run_tests "${exercise_dir}" "exemplar"
    done

    for exercise_dir in practice/*; do
        run_tests "${exercise_dir}" "example"
    done

}

main "$@"
