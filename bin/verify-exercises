#!/bin/bash

set -e

run_tests() {
    local file="${1//-/_}"
    local implementation_file="${2}"

    cd "$1"

    sed -i.bak 's#TEST_IGNORE();#// &#' "${file}"_test.c
    mv .meta/"${implementation_file}".asm "${file}".asm

    make clean
    make

    cd ..
}

main() {
    cd "$(dirname "$0")"/..

    rm -rf build
    cp -r exercises build

    cd build

    if [[ $# -gt 0 ]]; then
        for exercise in "$@"; do
            run_tests "${exercise}"
        done
    else
        for exercise in concept/*; do
            run_tests "${exercise}" "exemplar"
        done

        for exercise in practice/*; do
            run_tests "${exercise}" "example"
        done
    fi

}

main "$@"
